name: Compile & Package
on: push
jobs:
  compile-and-package:
    name: Compile Frontend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    steps:
      - uses: actions/checkout@v2
      - name: Cleanup backend
        working-directory: ./backend
        run: |
          rm -Rf static/drive
          rm RPiDrive_ng/settings/dev.py
          rm RPiDrive_ng/settings/prod.py
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - name: Compile Frontend
        working-directory: ./frontend
        run: |
          npm install @angular/cli -g
          npm install
          ng build --prod --aot --deployUrl=/static/drive/ --outputPath=../backend/static/drive/
      - name: Patch backend
        working-directory: ./backend
        run: |
          mv -f static/drive/index.html drive/templates/drive/index.html
      - name: Upload build
        uses: actions/upload-artifact@v2
        with:
          name: build
          path: backend/
      - name: Upload docker file
        uses: actions/upload-artifact@v2
        with:
          name: dockerfile
          path: .github/workflows/dockerfile
  create-docker-image:
    name: Create Docker Image
    needs: compile-and-package
    runs-on: ubuntu-latest
    steps:
      - name: Download build
        uses: actions/download-artifact@v2
        with:
          name: build
          path: build
      - name: Download dockerfile
        uses: actions/download-artifact@v2
        with:
          name: dockerfile
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to GitHub registry
        uses: docker/login-action@v1 
        with:
          registry: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Create and push docker image
        uses: docker/build-push-action@v2
        with:
          platforms: linux/amd64,linux/arm/v6,linux/arm/v7
          push: true
          tags: docker.pkg.github.com/kingkingyyk/rpidrive/base:develop